//@version=6
indicator('Highlight Time', overlay = true, max_lines_count = 500)

// Intrument are Symbols, eg: DJI, NAS, UK100, etc
instrument = syminfo.ticker

// Logging:
// Only on last bar & is newly generated bar
// So that the log is not clogged
// Ok nvm, when i switch to higher timeframe, it has no log, or waiting for one i dk
//      if barstate.islast and barstate.isnew       //
// This one will TRUE every tick.
if barstate.islast
    log.info(instrument + " " + timeframe.period)













//
// Draw Trading Time
//
var bool is_daylight_saving = false
var dst_start = ""
var dst_end = ""

// Default: from 8am to 12am, monday to sunday
var          session_time = "0800-2400"
const string session_days = ":1234567"
var my_session = session_time + session_days

if instrument == "JP225YJPY"
    session_time := "0800-1430"

if instrument == "HK50"
    session_time := "0900-1600"

if instrument == "CHINA50"
    session_time := "0900-1500"

// From what i understand
// timestamp("1 Jan 2025") is the UNIX time since 1 Jan 1970 in UTC +0
// Hence, you should convert UNIX time into UTC+0 first
// Then, you convvert again to Malaysia time GMT+8
// Hence, 1 Jan 2025, will be converted to 8am 1 Jan 2025 to your timezone
// Hence, all these timestamp() will be TRUE after 6am in your timezone
if instrument == "AUS200"
    dst_start := "06 Oct 2024"
    dst_end   := "06 Apr 2025"
    if  timenow > timestamp("6 Oct 2024") and timenow < timestamp("6 Apr 2025")
        session_time := "0700-1300"
        is_daylight_saving := true
    else
        session_time := "0800-1400"
        is_daylight_saving := false


if instrument == "UK100" or instrument == "GER40"
    dst_start := "30 Mar 2025"
    dst_end   := "26 Oct 2025"
    if  timenow > timestamp("30 Mar 2025") and timenow < timestamp("26 Oct 2025")
        session_time := "1500-2330"
        is_daylight_saving := true
    else
        session_time := "1600-0030"
        is_daylight_saving := false

if instrument == "NAS100" or instrument == "US30" or instrument == "SP500"
    dst_start := "09 Mar 2025"
    dst_end   := "02 Nov 2025"
    if  timenow > timestamp("09 Mar 2025") and timenow < timestamp("02 Nov 2025")
        session_time := "2130-0400"
        is_daylight_saving := true
    else
        session_time := "2230-0500"
        is_daylight_saving := false

my_session := session_time + session_days

// Check if the current time is within the specified range
inTimeRange = math.sign(nz(time(timeframe.period, my_session, "UTC+8")))

// Plot the background color if the current time is within the range
bgcolor(inTimeRange > 0 ? color.new(color.blue, 90) : na, title = "My session")


// Draw daylight saving time table
var dst_table = table.new(position = position.top_right, columns = 1, rows = 3, bgcolor = color.new(color.blue, 90), border_color=color.new(color.blue,50), border_width = 1)
if barstate.islast
    table.cell(table_id = dst_table, column = 0, row = 0, text_color=color.new(color.white, 30),text_size = size.small, text = is_daylight_saving ? "Daylight Saving" : "Standard")

    table.cell(table_id = dst_table, column = 0, row = 1, text_color=color.new(color.white, 30),text_size = size.small, text = session_time)

    table.cell(table_id = dst_table, column = 0, row = 2, text_color=color.new(color.white, 30),text_size = size.small, text = dst_start + " - " + dst_end)





















//
// Draw session break
// It will not draw on H4 and above time
//
var me_sessionBreak = 0
var draw_session_break = true
sessionBreak = time_tradingday

var four_hour = "240"
var daily = "1D"
var monthly = "1M"
var weekly = "1W"

if timeframe.period == four_hour
    draw_session_break := false
if timeframe.period == daily
    draw_session_break := false
if timeframe.period == monthly 
    draw_session_break := false
if timeframe.period == weekly
    draw_session_break := false

if draw_session_break
    if(sessionBreak!=me_sessionBreak)
        me_sessionBreak:=sessionBreak
        // label.new(x=bar_index, y=high, text="New Day")
        // no need bah i guess..
        // line.new(bar_index, low, bar_index, high, style = line.style_dashed)















//
// Draw ATH
// I realize that, if M5, the maximum candle is 5k
// Those ATH that is way before 5k candle, is missed
// Hence, the best way to draw ATH, is draw based on 12 Months timeframe
//

// Draw ATH on Yearly timeframe
// Request Highest for Yearly chart
var ATH = request.security(syminfo.tickerid, "12M", high)
ATH := math.max(high, ATH)

// But then i realize, if you on weekly chart, the value will be "NA"
// Not sure what happened but i guess, can put check if "NA", then draw 
// ATH based on current timeframe
if na(ATH)
    log.info("ATH is NA")
    ATH := high
    ATH := math.max(high, ATH)

// Plot the ATH on the M5 chart
plot_ATH = plot(ATH, color = color.new(color.yellow, 50), title = "ATH Plot", display = display.pane)
plot_price_low = plot(low, display = display.none, title = "Price Low Plot")
fill(plot_price_low, plot_ATH, color = color.new(color.yellow, 95), title = "ATH Fill")

